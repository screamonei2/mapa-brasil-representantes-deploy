<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Simples das Fun√ß√µes de Busca</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-input { width: 300px; padding: 8px; margin: 10px 0; }
        .test-button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 3px; }
        .highlight { background: #fff3cd; padding: 2px 4px; border-radius: 2px; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 3px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ Teste Simples das Fun√ß√µes de Busca</h1>
    
    <div class="test-section">
        <h2>üîç Teste das Fun√ß√µes de Busca</h2>
        <p>Este teste verifica se as fun√ß√µes de busca est√£o funcionando corretamente.</p>
        
        <div>
            <input type="text" id="test-input" class="test-input" placeholder="Digite um termo para testar" value="Vila Madalena">
            <button onclick="testarFuncoes()" class="test-button">Testar Fun√ß√µes</button>
        </div>
        <div id="test-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Status das Fun√ß√µes</h2>
        <div id="status-funcoes"></div>
    </div>

    <script>
        // Dados simulados para teste
        const representativesData = [
            {
                id: "rep1",
                NomeRepresentante: "REPRESENTANTE SP",
                EstadosDetalhados: {
                    "SP": {
                        cidades: ["S√£o Paulo"],
                        bairros: [
                            "VILA MADALENA",
                            "PINHEIROS",
                            "CENTRO",
                            "VILA PRUDENTE",
                            "TATUAPE",
                            "MOOCA",
                            "PENHA",
                            "BRAS",
                            "PARI",
                            "BELEM"
                        ]
                    }
                }
            },
            {
                id: "rep2",
                NomeRepresentante: "REPRESENTANTE CURITIBA",
                EstadosDetalhados: {
                    "PR": {
                        cidades: ["Curitiba", "Londrina"]
                    }
                }
            },
            {
                id: "rep3",
                NomeRepresentante: "REPRESENTANTE CURITIBANOS",
                EstadosDetalhados: {
                    "SC": {
                        cidades: ["Curitibanos", "Blumenau"]
                    }
                }
            }
        ];

        // Fun√ß√£o para calcular similaridade entre strings (Levenshtein distance)
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // Implementa√ß√£o do algoritmo de Levenshtein
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // Fun√ß√£o para normalizar strings
        function normalize(str) {
            return (str || "")
                .toString()
                .normalize("NFD")
                .replace(/[ÃÄ-ÕØ]/g, "")
                .replace(/[^\w\s]/gi, "")
                .replace(/\s+/g, " ")
                .trim()
                .toLowerCase();
        }

        // Fun√ß√£o para determinar o tipo de busca
        function determineSearchType(query) {
            const normalizedQuery = normalize(query);
            
            // 1. Verificar se √© busca por estado (sigla ou nome completo)
            const statePatterns = [
                /^(sp|rj|mg|ba|pr|rs|pe|ce|pa|sc|go|ma|pb|am|es|mt|al|pi|df|ms|se|rn|ro|ac|ap|rr|to)$/i,
                /^(s√£o paulo|rio de janeiro|minas gerais|bahia|paran√°|rio grande do sul|pernambuco|cear√°|par√°|santa catarina|goi√°s|maranh√£o|para√≠ba|amazonas|esp√≠rito santo|mato grosso|alagoas|piau√≠|distrito federal|mato grosso do sul|sergipe|rio grande do norte|rond√¥nia|acre|amap√°|roraima|tocantins)$/i
            ];
            
            for (const pattern of statePatterns) {
                if (pattern.test(normalizedQuery)) {
                    return { type: 'estado', query: normalizedQuery };
                }
            }
            
            // 2. Verificar se √© busca por bairro de S√£o Paulo
            if (normalizedQuery.includes('vila') || 
                normalizedQuery.includes('jardim') || 
                normalizedQuery.includes('jd') ||
                normalizedQuery.includes('centro') ||
                normalizedQuery.includes('bairro') ||
                normalizedQuery.includes('distrito') ||
                normalizedQuery.includes('cid') ||
                normalizedQuery.includes('parque') ||
                normalizedQuery.includes('sao') ||
                normalizedQuery.includes('jose') ||
                normalizedQuery.includes('ermelino') ||
                normalizedQuery.includes('itaquera') ||
                normalizedQuery.includes('tatuape') ||
                normalizedQuery.includes('penha') ||
                normalizedQuery.includes('mooca') ||
                normalizedQuery.includes('bras') ||
                normalizedQuery.includes('pari') ||
                normalizedQuery.includes('belem') ||
                normalizedQuery.includes('agua') ||
                normalizedQuery.includes('sapopemba') ||
                normalizedQuery.includes('aracanduva') ||
                normalizedQuery.includes('cangaiba') ||
                normalizedQuery.includes('guaiases') ||
                normalizedQuery.includes('lajeado') ||
                normalizedQuery.includes('carrao') ||
                normalizedQuery.includes('formosa') ||
                normalizedQuery.includes('carmo') ||
                normalizedQuery.includes('mateus') ||
                normalizedQuery.includes('rafael') ||
                normalizedQuery.includes('iguatemi') ||
                normalizedQuery.includes('bonifacio')) {
                return { type: 'bairro', query: normalizedQuery };
            }
            
            // 3. Verificar se √© busca por cidade espec√≠fica
            return { type: 'cidade', query: normalizedQuery };
        }

        // Fun√ß√£o para buscar em bairros de S√£o Paulo
        function searchInBairros(query) {
            const foundIds = new Set();
            
            console.log(`üîç Buscando bairros para: "${query}"`);
            
            // Buscar em todos os representantes que t√™m bairros mapeados
            representativesData.forEach(rep => {
                if (rep.EstadosDetalhados && rep.EstadosDetalhados.SP && rep.EstadosDetalhados.SP.bairros) {
                    const bairros = rep.EstadosDetalhados.SP.bairros;
                    
                    bairros.forEach(bairro => {
                        const normalizedBairro = normalize(bairro);
                        const normalizedQuery = normalize(query);
                        
                        // Busca exata primeiro
                        if (normalizedBairro === normalizedQuery) {
                            console.log(`‚úÖ Match exato encontrado: "${bairro}" para representante "${rep.NomeRepresentante}"`);
                            foundIds.add(rep.id);
                            return;
                        }
                        
                        // Busca por similaridade
                        const similarity = calculateSimilarity(normalizedBairro, normalizedQuery);
                        if (similarity > 0.7) { // Threshold de 70% de similaridade
                            console.log(`üîç Match similar encontrado: "${bairro}" (${(similarity * 100).toFixed(1)}%) para representante "${rep.NomeRepresentante}"`);
                            foundIds.add(rep.id);
                        }
                    });
                }
            });
            
            console.log(`üìä Total de representantes encontrados para bairros: ${foundIds.size}`);
            return foundIds;
        }

        // Fun√ß√£o para buscar em cidades com diferencia√ß√£o inteligente
        function searchInCidades(query) {
            const foundIds = new Set();
            const exactMatches = [];
            const partialMatches = [];
            const similarMatches = [];
            
            // Coletar todas as cidades √∫nicas com seus estados
            const cidadesUnicas = new Map(); // cidade -> [estados]
            
            representativesData.forEach(rep => {
                if (rep.EstadosDetalhados) {
                    Object.entries(rep.EstadosDetalhados).forEach(([estado, dadosEstado]) => {
                        if (dadosEstado.cidades && Array.isArray(dadosEstado.cidades)) {
                            dadosEstado.cidades.forEach(cidade => {
                                const normalizedCidade = normalize(cidade);
                                if (!cidadesUnicas.has(normalizedCidade)) {
                                    cidadesUnicas.set(normalizedCidade, []);
                                }
                                if (!cidadesUnicas.get(normalizedCidade).includes(estado)) {
                                    cidadesUnicas.get(normalizedCidade).push(estado);
                                }
                            });
                        }
                    });
                }
            });
            
            // Classificar as cidades por tipo de match
            for (const [cidade, estados] of cidadesUnicas.entries()) {
                // 1. Match exato
                if (cidade === query) {
                    exactMatches.push({ cidade, estados });
                }
                // 2. Match parcial (come√ßa com a query)
                else if (cidade.startsWith(query) && query.length >= 3) {
                    partialMatches.push({ cidade, estados });
                }
                // 3. Match por similaridade
                else {
                    const similarity = calculateSimilarity(cidade, query);
                    if (similarity > 0.7) { // Threshold de 70% de similaridade
                        similarMatches.push({ cidade, estados, similarity });
                    }
                }
            }
            
            // Ordenar matches similares por similaridade
            similarMatches.sort((a, b) => b.similarity - a.similarity);
            
            // Processar matches exatos primeiro
            exactMatches.forEach(({ cidade, estados }) => {
                const representatives = getRepresentativesByCidade(cidade, estados);
                representatives.forEach(rep => foundIds.add(rep.id));
            });
            
            // Se n√£o h√° matches exatos, processar parciais
            if (exactMatches.length === 0 && partialMatches.length > 0) {
                partialMatches.forEach(({ cidade, estados }) => {
                    const representatives = getRepresentativesByCidade(cidade, estados);
                    representatives.forEach(rep => foundIds.add(rep.id));
                });
            }
            
            // Se ainda n√£o h√° resultados, processar similares
            if (foundIds.size === 0 && similarMatches.length > 0) {
                // Limitar a 3 matches similares para evitar polui√ß√£o
                similarMatches.slice(0, 3).forEach(({ cidade, estados }) => {
                    const representatives = getRepresentativesByCidade(cidade, estados);
                    representatives.forEach(rep => foundIds.add(rep.id));
                });
            }
            
            return foundIds;
        }

        // Fun√ß√£o para obter representantes por cidade e estados
        function getRepresentativesByCidade(cidade, estados) {
            const representatives = [];
            
            representativesData.forEach(rep => {
                if (rep.EstadosDetalhados) {
                    Object.entries(rep.EstadosDetalhados).forEach(([estado, dadosEstado]) => {
                        if (estados.includes(estado) && dadosEstado.cidades && Array.isArray(dadosEstado.cidades)) {
                            if (dadosEstado.cidades.some(c => normalize(c) === cidade)) {
                                representatives.push(rep);
                            }
                        }
                    });
                }
            });
            
            return representatives;
        }

        // Fun√ß√£o para buscar representantes com busca inteligente
        function searchRepresentatives(query) {
            if (!query) return [];

            const searchType = determineSearchType(query);
            const normalizedQuery = searchType.query;
            const foundRepresentativeIds = new Set();

            console.log(`üîç Tipo de busca: ${searchType.type} para "${query}"`);

            switch (searchType.type) {
                case 'estado':
                    // Busca por estado - mais direta
                    representativesData.forEach(rep => {
                        if (rep.EstadosDetalhados && rep.EstadosDetalhados[normalizedQuery.toUpperCase()]) {
                            foundRepresentativeIds.add(rep.id);
                        }
                    });
                    break;

                case 'bairro':
                    // Busca por bairro - priorizar bairros de S√£o Paulo
                    const bairroResults = searchInBairros(normalizedQuery);
                    bairroResults.forEach(id => foundRepresentativeIds.add(id));
                    break;

                case 'cidade':
                    // Busca por cidade - implementar busca fuzzy inteligente
                    const cidadeResults = searchInCidades(normalizedQuery);
                    cidadeResults.forEach(id => foundRepresentativeIds.add(id));
                    break;
            }

            // Busca adicional por nome do representante
            representativesData.forEach(rep => {
                if (normalize(rep.NomeRepresentante).includes(normalizedQuery)) {
                    foundRepresentativeIds.add(rep.id);
                }
            });

            return representativesData.filter(rep => foundRepresentativeIds.has(rep.id));
        }

        // Fun√ß√£o principal de teste
        function testarFuncoes() {
            const query = document.getElementById('test-input').value;
            const resultDiv = document.getElementById('test-result');
            
            try {
                console.log('üß™ Iniciando teste das fun√ß√µes...');
                
                // Testar todas as fun√ß√µes
                const searchType = determineSearchType(query);
                const results = searchRepresentatives(query);
                
                let html = `<h3>Resultado do Teste: "${query}"</h3>`;
                html += `<p><strong>Tipo detectado:</strong> <span class="highlight">${searchType.type}</span></p>`;
                html += `<p><strong>Query normalizada:</strong> <span class="highlight">${searchType.query}</span></p>`;
                
                html += `<h4>üìä Resultados (${results.length}):</h4>`;
                if (results.length > 0) {
                    results.forEach(rep => {
                        html += `<div>‚Ä¢ <strong>${rep.NomeRepresentante}</strong> (ID: ${rep.id})</div>`;
                    });
                } else {
                    html += `<div>Nenhum resultado encontrado</div>`;
                }
                
                // Testar fun√ß√£o espec√≠fica de bairros
                if (searchType.type === 'bairro') {
                    html += `<h4>üèòÔ∏è Teste Espec√≠fico de Bairros:</h4>`;
                    const bairroResults = searchInBairros(searchType.query);
                    html += `<p>Representantes encontrados por bairros: ${bairroResults.size}</p>`;
                    
                    if (bairroResults.size > 0) {
                        const bairroReps = representativesData.filter(rep => bairroResults.has(rep.id));
                        bairroReps.forEach(rep => {
                            html += `<div>‚Ä¢ <strong>${rep.NomeRepresentante}</strong> - Bairros: ${rep.EstadosDetalhados.SP.bairros.join(', ')}</div>`;
                        });
                    }
                }
                
                html += `<div class="success">‚úÖ Teste conclu√≠do com sucesso!</div>`;
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå Erro durante o teste:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå Erro durante o teste: ${error.message}</div>`;
            }
        }

        // Verificar status das fun√ß√µes
        function verificarStatusFuncoes() {
            const statusDiv = document.getElementById('status-funcoes');
            let html = '<h3>üìä Status das Fun√ß√µes</h3>';
            
            try {
                // Testar fun√ß√£o normalize
                const testNormalize = normalize("S√£o Paulo");
                html += `<div class="success">‚úÖ normalize(): ${testNormalize}</div>`;
                
                // Testar fun√ß√£o calculateSimilarity
                const testSimilarity = calculateSimilarity("curitiba", "curitibanos");
                html += `<div class="success">‚úÖ calculateSimilarity(): ${(testSimilarity * 100).toFixed(1)}%</div>`;
                
                // Testar fun√ß√£o determineSearchType
                const testSearchType = determineSearchType("Vila Madalena");
                html += `<div class="success">‚úÖ determineSearchType(): ${testSearchType.type}</div>`;
                
                // Testar fun√ß√£o searchInBairros
                const testBairros = searchInBairros("vila madalena");
                html += `<div class="success">‚úÖ searchInBairros(): ${testBairros.size} resultados</div>`;
                
                // Testar fun√ß√£o searchInCidades
                const testCidades = searchInCidades("curitiba");
                html += `<div class="success">‚úÖ searchInCidades(): ${testCidades.size} resultados</div>`;
                
                // Testar fun√ß√£o searchRepresentatives
                const testSearch = searchRepresentatives("vila madalena");
                html += `<div class="success">‚úÖ searchRepresentatives(): ${testSearch.length} resultados</div>`;
                
                html += '<div class="success">üéâ Todas as fun√ß√µes est√£o funcionando corretamente!</div>';
                
            } catch (error) {
                html += `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
            
            statusDiv.innerHTML = html;
        }

        // Executar verifica√ß√£o de status ao carregar a p√°gina
        window.addEventListener('load', verificarStatusFuncoes);
    </script>
</body>
</html>
